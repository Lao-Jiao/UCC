<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>UCC计算服务</title>
    <style>
        body {
            background-color: #1a1c1e;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .button {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            margin: 15px 0;
        }
        #link {
            margin-top: 20px;
        }
        #link a {
            color: #4CAF50;
            text-decoration: none;
        }
        #link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>UCC文件处理</h1>
        <input type="file" id="fileInput" accept=".ucc" style="display: none">
        <button class="button" onclick="document.getElementById('fileInput').click()">选择UCC文件</button>
        <div id="link"></div>
    </div>

<script>
// 核心计算函数
function calculateModuleSize(buffer) {
    const bytes = new Uint8Array(buffer);
    const hexString = Array.from(bytes).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join('');
    let objectCount = 0;
    let structCount = 0;
    let totalSize = 0;

    const moduleSizes = {
        "61": 6, "0E": 1, "23": 1, "24": 1, "25": 1, "62": 1, 
        "5E": 1, "5F": 1, "5C": 1, "5D": 1, "60": 1,
        "57": 1, "58": 5, "64": 1, "65": 48, "66": 4,
        "67": 1, "68": 3, "69": 6, "6A": 44, "6B": 14,
        "6C": 3, "6D": 1, "6E": 1, "6F": 1, "70": 24,
        "71": 1, "72": 48, "73": 13, "74": 1, "75": 1,
        "76": 13, "77": 7, "78": 3, "79": 19, "7A": 26,
        "7B": 13, "7C": 23, "7D": 9, "7E": 25, "7F": 6,
        "80": 14, "81": 45, "82": 2, "83": 2, "84": 13,
        "85": 19, "86": 7, "87": 13, "88": 36
    };

    const objectPattern = "4F626A656374";
    let pos = 0;
    while(true) {
        pos = hexString.indexOf(objectPattern, pos);
        if(pos === -1) break;

        if (pos >= 288) {
            const startPos = pos - 288;
            const contentToCheck = hexString.substring(startPos, pos);
            const firstByte = contentToCheck.substr(0, 2);
            const isPartOfStruct = contentToCheck.includes("537472756374");

            if((firstByte === "00" || firstByte === "0D") && !isPartOfStruct) {
                objectCount++;
                let additionalSize = 1;

                if (pos >= 264) {
                    const sizeCheckPos = pos - 264;
                    const byteToCheck = hexString.substr(sizeCheckPos, 2);

                    if (byteToCheck === "59") {
                        if (pos >= 288) {
                            const specialCheckPos = pos - 288;
                            const specialByte = hexString.substr(specialCheckPos, 2);
                            if (specialByte === "0D") {
                                const floatStartPos = specialCheckPos + 56 * 2;
                                const floatHex = hexString.substr(floatStartPos, 8);
                                
                                const bytes = new Uint8Array(4);
                                for (let i = 0; i < 4; i++) {
                                    bytes[i] = parseInt(floatHex.substr(i * 2, 2), 16);
                                }
                                const floatView = new Float32Array(bytes.buffer);
                                const floatValue = floatView[0];
                                
                                additionalSize = Math.floor(floatValue);
                            }
                        }
                    } else if (moduleSizes[byteToCheck]) {
                        additionalSize = moduleSizes[byteToCheck];
                    }
                }
                totalSize += additionalSize;
            }
        }
        pos += objectPattern.length;
    }

    return { objectCount, structCount, totalSize };
}

// 文件处理
document.getElementById('fileInput').addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const buffer = e.target.result;
            const result = calculateModuleSize(buffer);
            
            // 准备数据
            const data = {
                fileName: file.name,
                ...result
            };
            
            // 创建URL参数
            const params = new URLSearchParams();
            params.append('data', JSON.stringify(data));
            
            // 生成前端页面URL（根据实际路径修改）
            const url = `../frontend/frontend.html?${params.toString()}`;
            
            // 显示链接
            const linkElem = document.getElementById('link');
            linkElem.innerHTML = `
                <p>处理完成！</p>
                <a href="${url}" target="_blank">点击查看结果</a>
            `;
        };
        reader.readAsArrayBuffer(file);
    }
});
</script>
</body>
</html>